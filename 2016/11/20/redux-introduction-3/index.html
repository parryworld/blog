<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    <meta name="description" content="Think less, do more.">
  

  
    <meta name="author" content="parryworld">
  

  
  <title>Redux 介绍（三）：中间件 Middleware | Parryworld</title>

  <link rel="stylesheet" href="/blog/css/style.css">

  <link href='//fonts.googleapis.com/css?family=Bitter:400,700,400italic|Open+Sans:400italic,600italic,400,600' rel='stylesheet' type='text/css'>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>

    <section class="container">
  <header class="post-header">
    <h1>Redux 介绍（三）：中间件 Middleware</h1>
  </header>

  <article class="post-body">
    <p>Redux 中的 middleware 位于 action 发出后，到达 reducer 之前的时间点，在 middleware 中，我们可以接收到这个 action，并执行一些操作，比如打印日志，调用其他接口等等。</p>
<p>下面我们以记录日志为例讲解一下 middleware 的基本原理。</p>
<h2 id="记录日志的-Middleware"><a href="#记录日志的-Middleware" class="headerlink" title="记录日志的 Middleware"></a>记录日志的 Middleware</h2><p>首先，我们先给出最简单的记录日志的 middleware 形式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> logger = <span class="function"><span class="params">store</span> =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line"></div><div class="line">  <span class="comment">// 记录发送出去的 action</span></div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'dispatching'</span>, action);</div><div class="line">  </div><div class="line">  <span class="comment">// 继续往下传给下一个 middleware 或者最终传给 reducer</span></div><div class="line">  <span class="keyword">let</span> result = next(action);</div><div class="line">  </div><div class="line">  <span class="comment">// 最终完成一次 state 修改后，记录新的 state tree</span></div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'next state'</span>, store.getState());</div><div class="line">  </div><div class="line">  <span class="comment">// 返回值</span></div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个 middleware 实现了打印 action 和打印新的 state tree 的功能。一开始看到这个代码块，一般很难理解其中的工作原理，下面我们根据这个 middleware 做进一步的分析。</p>
<h2 id="Middleware-工作原理"><a href="#Middleware-工作原理" class="headerlink" title="Middleware 工作原理"></a>Middleware 工作原理</h2><p>把上面的 middleware 的箭头函数还原后应该是下面这个样子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">store</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapDispatchToAddLogging</span>(<span class="params">next</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchAndLog</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'dispatching'</span>, action);</div><div class="line">      <span class="keyword">let</span> result = next(action);</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'next state'</span>, store.getState());</div><div class="line">      <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于上述代码，我们可能会好奇这三个传入的参数 store, next, action 到底有什么作用。</p>
<ul>
<li>对于 store，其实很好理解，我们的目的是 dispatch action，所以传入 store 是为了调用 <code>store.dispatch()</code></li>
<li>对于 action，一方面是为了 dispatch 这个 action，另一方面是在 middleware 中得到 这个 action 来作特定的一些操作。</li>
</ul>
<p>那么 next 这个参数到底是什么含义呢？事实上，在应用中我们还是和平常一样通过调用 <code>dispatch(action)</code> 来改变 state。在这个过程中， middleware 已经被封装起来了，所以 next 的作用就是把一个又一个 middleware 封装在 <code>store.dispatch()</code> 里。我们来看下面这段代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">store, middlewares</span>) </span>&#123;</div><div class="line">  middlewares = middlewares.slice();</div><div class="line">  middlewares.reverse();</div><div class="line"></div><div class="line">  <span class="keyword">let</span> dispatch = store.dispatch;</div><div class="line">  middlewares.forEach(<span class="function"><span class="params">middleware</span> =&gt;</span></div><div class="line">    dispatch = middleware(store)(dispatch)</div><div class="line">  )</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, store, &#123; dispatch &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码段不是 Redux 中真实的 <code>applyMiddleware()</code>，这只是一种单纯的实现方式，主要是为了方便我们理解其中的原理。</p>
<p>从这段代码中，我们就明白了 next 的作用，每一次调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch = middleware(store)(dispatch)</div></pre></td></tr></table></figure>
<p>就把上一次的 <code>dispacth</code> 传给了 next 参数，然后返回一个新的 <code>dispatch</code>，这个过程就把一个 middleware 的功能添加进了 <code>dispatch</code> 中。最后返回一个新的 store 副本，<code>store.dispatch()</code> 中就包括了所有的 middleware 了。</p>
<h2 id="使用-Middleware"><a href="#使用-Middleware" class="headerlink" title="使用 Middleware"></a>使用 Middleware</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app/store/logger.js</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> logger = <span class="function"><span class="params">store</span> =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'dispatching'</span>, action);</div><div class="line">  <span class="keyword">let</span> result = next(action);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'next state'</span>, store.getState());</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将 middleware 引入到 store 中，我们也可以引入一些开源的 middleware。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app/store/index.js</span></div><div class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">'../reducers'</span>;</div><div class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</div><div class="line"><span class="keyword">import</span> &#123; logger &#125; <span class="keyword">from</span> <span class="string">'./logger'</span>;</div><div class="line"></div><div class="line"><span class="keyword">let</span> createStoreWithMiddleware = applyMiddleware(logger, thunk)(createStore);</div><div class="line"></div><div class="line"><span class="keyword">let</span> store = createStoreWithMiddleware(rootReducer);</div></pre></td></tr></table></figure>
<p>最后，我们正常调用 <code>dispatch()</code> 来 dispatch action 就能实现包含的 middleware 了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch(addTodo(<span class="string">'Middleware'</span>));</div></pre></td></tr></table></figure>
<h3 id="系列文章"><a href="#系列文章" class="headerlink" title="系列文章:"></a>系列文章:</h3><p><a href="http://parryworld.me/blog/2016/11/19/redux-introduction-1/">Redux 介绍（一）：基础教程</a></p>
<p><a href="http://parryworld.me/blog/2016/11/19/redux-introduction-2/">Redux 介绍（二）：异步 Thunk</a></p>

  </article>

  <footer class="post-footer">
  <div class="contact clearfix">
    <div class="social">
      <span>Contact me @ </span>
      <div class="icon-wrapper">
        <svg class="social-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22,3H2A2,2,0,0,0,0,5V19a2,2,0,0,0,2,2H22a2,2,0,0,0,2-2V5A2,2,0,0,0,22,3ZM12,9.88,4.07,4H19.93ZM4,9.21l7.7,5.69a.5.5,0,0,0,.59,0L20,9.21V20H4Z" />
        </svg>
        <div class="icon-info">
          <p>parryworld@gmail.com</p>
        </div>
      </div>
      <a href="https://github.com/parryworld" target="_blank">
        <svg class="social-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
          <path d="M512 0C229.25 0 0 229.25 0 512c0 226.25 146.688 418.125 350.156 485.812 25.594 4.688 34.938-11.125 34.938-24.625 0-12.188-0.469-52.562-0.719-95.312C242 908.812 211.906 817.5 211.906 817.5c-23.312-59.125-56.844-74.875-56.844-74.875-46.531-31.75 3.53-31.125 3.53-31.125 51.406 3.562 78.47 52.75 78.47 52.75 45.688 78.25 119.875 55.625 149 42.5 4.654-33 17.904-55.625 32.5-68.375C304.906 725.438 185.344 681.5 185.344 485.312c0-55.938 19.969-101.562 52.656-137.406-5.219-13-22.844-65.094 5.062-135.562 0 0 42.938-13.75 140.812 52.5 40.812-11.406 84.594-17.031 128.125-17.219 43.5 0.188 87.312 5.875 128.188 17.281 97.688-66.312 140.688-52.5 140.688-52.5 28 70.531 10.375 122.562 5.125 135.5 32.812 35.844 52.625 81.469 52.625 137.406 0 196.688-119.75 240-233.812 252.688 18.438 15.875 34.75 47 34.75 94.75 0 68.438-0.688 123.625-0.688 140.5 0 13.625 9.312 29.562 35.25 24.562C877.438 930 1024 738.125 1024 512 1024 229.25 794.75 0 512 0z"/>
        </svg>
      </a>
      <a href="http://weibo.com/parryworld" target="_blank">
        <svg class="social-icon" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
          <path d="M675 1284q21-34 11-69t-45-50q-34-14-73-1t-60 46q-22 34-13 68.5t43 50.5 74.5 2.5 62.5-47.5zm94-121q8-13 3.5-26.5t-17.5-18.5q-14-5-28.5.5t-21.5 18.5q-17 31 13 45 14 5 29-.5t22-18.5zm174 107q-45 102-158 150t-224 12q-107-34-147.5-126.5t6.5-187.5q47-93 151.5-139t210.5-19q111 29 158.5 119.5t2.5 190.5zm312-160q-9-96-89-170t-208.5-109-274.5-21q-223 23-369.5 141.5t-132.5 264.5q9 96 89 170t208.5 109 274.5 21q223-23 369.5-141.5t132.5-264.5zm308 4q0 68-37 139.5t-109 137-168.5 117.5-226 83-270.5 31-275-33.5-240.5-93-171.5-151-65-199.5q0-115 69.5-245t197.5-258q169-169 341.5-236t246.5 7q65 64 20 209-4 14-1 20t10 7 14.5-.5 13.5-3.5l6-2q139-59 246-59t153 61q45 63 0 178-2 13-4.5 20t4.5 12.5 12 7.5 17 6q57 18 103 47t80 81.5 34 116.5zm-74-624q42 47 54.5 108.5t-6.5 117.5q-8 23-29.5 34t-44.5 4q-23-8-34-29.5t-4-44.5q20-63-24-111t-107-35q-24 5-45-8t-25-37q-5-24 8-44.5t37-25.5q60-13 119 5.5t101 65.5zm181-163q87 96 112.5 222.5t-13.5 241.5q-9 27-34 40t-52 4-40-34-5-52q28-82 10-172t-80-158q-62-69-148-95.5t-173-8.5q-28 6-52-9.5t-30-43.5 9.5-51.5 43.5-29.5q123-26 244 11.5t208 134.5z"/>
        </svg>
      </a>
    </div>
  </div>
</footer>
</section>

</body>
</html>

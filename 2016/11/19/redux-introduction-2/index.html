<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    <meta name="description" content="Think less, do more.">
  

  
    <meta name="author" content="parryworld">
  

  
  <title>Redux 介绍（二）：异步 Thunk | Parryworld</title>

  <link rel="stylesheet" href="/blog/css/style.css">

  <link href='//fonts.googleapis.com/css?family=Bitter:400,700,400italic|Open+Sans:400italic,600italic,400,600' rel='stylesheet' type='text/css'>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>

    <section class="container">
  <header class="post-header">
    <h1>Redux 介绍（二）：异步 Thunk</h1>
  </header>

  <article class="post-body">
    <p>Redux 的 action 只是一个普通对象，调用 <code>dispatch(action)</code> 之后就会立即改变 state。</p>
<p>当我们要调用异步 API 时，会有两个时间点：一个是发送请求的时刻，另一个是接收响应的时刻。在第一个时刻，我们一般会显示一个 loading 控件，在第二个时刻，我们可能会刷新列表。显然，在两个时间点上，我们都需要 dispatch action。</p>
<p>对于每一个 API 请求，我们一般会有以下三种 action：</p>
<ul>
<li>一种表示请求开始的 action</li>
<li>一种表示请求成功的 action</li>
<li>一种表示请求失败的 action</li>
</ul>
<p>可以定义三个不同的 type 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">type</span>: <span class="string">'FETCH_POSTS'</span> &#125;</div><div class="line">&#123; <span class="attr">type</span>: <span class="string">'RECEIVE_POSTS_FAILURE'</span>, error &#125;</div><div class="line">&#123; <span class="attr">type</span>: <span class="string">'RECEIVE_POSTS_SUCCESS'</span>, posts &#125;</div></pre></td></tr></table></figure>
<h2 id="创建-Action-和-Reducer"><a href="#创建-Action-和-Reducer" class="headerlink" title="创建 Action 和 Reducer"></a>创建 Action 和 Reducer</h2><p>简单起见，我们不考虑请求失败的错误处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app/actions/post.js</span></div><div class="line"><span class="keyword">import</span> &#123; FETCH_POSTS, RECEIVE_POSTS &#125; <span class="keyword">from</span> <span class="string">'../constants/actionType'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchPosts</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: FETCH_POSTS</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">receivePosts</span>(<span class="params">posts</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: RECEIVE_POSTS,</div><div class="line">    posts</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app/reducers/post.js</span></div><div class="line"><span class="keyword">import</span> &#123; FETCH_POSTS, RECEIVE_POSTS &#125; <span class="keyword">from</span> <span class="string">'../constants/actionType'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> initialState = &#123;</div><div class="line">  <span class="attr">isFetching</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">posts</span>: []</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params">state = initialState, action</span>) </span>&#123;</div><div class="line">  <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">    <span class="keyword">case</span> FETCH_POSTS:</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;</div><div class="line">        <span class="attr">isFetching</span>: <span class="literal">true</span>,</div><div class="line">      &#125;)</div><div class="line">    <span class="keyword">case</span> RECEIVE_POSTS:</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;</div><div class="line">        <span class="attr">isFetching</span>: <span class="literal">false</span>,</div><div class="line">        <span class="attr">posts</span>: action.posts,</div><div class="line">      &#125;)</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> state;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用-Redux-Thunk"><a href="#使用-Redux-Thunk" class="headerlink" title="使用 Redux Thunk"></a>使用 Redux Thunk</h2><p>我们需要引入 <code>redux-thunk</code> 这个库来把上面同步的 action 和异步请求联结起来。<code>redux-thunk</code> 是 Redux 的一个 middleware，可以使得 action 创建函数不但可以返回 action 对象还可以返回一个函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app/actions/post.js</span></div><div class="line"><span class="keyword">import</span> &#123; FETCH_POSTS, RECEIVE_POSTS &#125; <span class="keyword">from</span> <span class="string">'../constants/actionType'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchPosts</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: FETCH_POSTS</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">receivePosts</span>(<span class="params">posts</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: RECEIVE_POSTS,</div><div class="line">    posts</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 这就是我们需要的 thunk 函数</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getPosts</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">dispatch</span>) </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">// 异步请求前，dispatch 请求开始</span></div><div class="line">    dispatch(fetchPosts());</div><div class="line">    </div><div class="line">    <span class="comment">// 开始异步 API 请求</span></div><div class="line">    <span class="keyword">return</span> fetch(url)</div><div class="line">      .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</div><div class="line">      .then(<span class="function"><span class="params">responseJson</span> =&gt;</span></div><div class="line">      </div><div class="line">        <span class="comment">// 收到响应后，dispatch 接收响应，更新 posts</span></div><div class="line">        dispatch(receivePosts(responseJson.data.posts))</div><div class="line">      )</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除此之外，我们需要在 store 中通过 <code>applyMiddleware()</code> 引入 <code>redux-thunk</code>，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app/store/index.js</span></div><div class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</div><div class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">'../reducers'</span>;</div><div class="line"></div><div class="line"><span class="keyword">let</span> createStoreWithMiddleware = applyMiddleware(thunk)(createStore);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStoreWithMiddleware(rootReducer);</div></pre></td></tr></table></figure>
<p>最后，我们就可以通过 <code>dispatch()</code> 来调用异步请求了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch(getPosts(url));</div></pre></td></tr></table></figure>
<h3 id="系列文章"><a href="#系列文章" class="headerlink" title="系列文章:"></a>系列文章:</h3><p><a href="http://parryworld.me/blog/2016/11/19/redux-introduction-1/">Redux 介绍（一）：基础教程</a></p>
<p><a href="http://parryworld.me/blog/2016/11/20/redux-introduction-3/">Redux 介绍（三）：中间件 Middleware</a></p>

  </article>

  <footer class="post-footer">
  <div class="contact clearfix">
    <div class="social">
      <span>Contact me @ </span>
      <div class="icon-wrapper">
        <svg class="social-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22,3H2A2,2,0,0,0,0,5V19a2,2,0,0,0,2,2H22a2,2,0,0,0,2-2V5A2,2,0,0,0,22,3ZM12,9.88,4.07,4H19.93ZM4,9.21l7.7,5.69a.5.5,0,0,0,.59,0L20,9.21V20H4Z" />
        </svg>
        <div class="icon-info">
          <p>parryworld@gmail.com</p>
        </div>
      </div>
      <a href="https://github.com/parryworld" target="_blank">
        <svg class="social-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
          <path d="M512 0C229.25 0 0 229.25 0 512c0 226.25 146.688 418.125 350.156 485.812 25.594 4.688 34.938-11.125 34.938-24.625 0-12.188-0.469-52.562-0.719-95.312C242 908.812 211.906 817.5 211.906 817.5c-23.312-59.125-56.844-74.875-56.844-74.875-46.531-31.75 3.53-31.125 3.53-31.125 51.406 3.562 78.47 52.75 78.47 52.75 45.688 78.25 119.875 55.625 149 42.5 4.654-33 17.904-55.625 32.5-68.375C304.906 725.438 185.344 681.5 185.344 485.312c0-55.938 19.969-101.562 52.656-137.406-5.219-13-22.844-65.094 5.062-135.562 0 0 42.938-13.75 140.812 52.5 40.812-11.406 84.594-17.031 128.125-17.219 43.5 0.188 87.312 5.875 128.188 17.281 97.688-66.312 140.688-52.5 140.688-52.5 28 70.531 10.375 122.562 5.125 135.5 32.812 35.844 52.625 81.469 52.625 137.406 0 196.688-119.75 240-233.812 252.688 18.438 15.875 34.75 47 34.75 94.75 0 68.438-0.688 123.625-0.688 140.5 0 13.625 9.312 29.562 35.25 24.562C877.438 930 1024 738.125 1024 512 1024 229.25 794.75 0 512 0z"/>
        </svg>
      </a>
      <a href="http://weibo.com/parryworld" target="_blank">
        <svg class="social-icon" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
          <path d="M675 1284q21-34 11-69t-45-50q-34-14-73-1t-60 46q-22 34-13 68.5t43 50.5 74.5 2.5 62.5-47.5zm94-121q8-13 3.5-26.5t-17.5-18.5q-14-5-28.5.5t-21.5 18.5q-17 31 13 45 14 5 29-.5t22-18.5zm174 107q-45 102-158 150t-224 12q-107-34-147.5-126.5t6.5-187.5q47-93 151.5-139t210.5-19q111 29 158.5 119.5t2.5 190.5zm312-160q-9-96-89-170t-208.5-109-274.5-21q-223 23-369.5 141.5t-132.5 264.5q9 96 89 170t208.5 109 274.5 21q223-23 369.5-141.5t132.5-264.5zm308 4q0 68-37 139.5t-109 137-168.5 117.5-226 83-270.5 31-275-33.5-240.5-93-171.5-151-65-199.5q0-115 69.5-245t197.5-258q169-169 341.5-236t246.5 7q65 64 20 209-4 14-1 20t10 7 14.5-.5 13.5-3.5l6-2q139-59 246-59t153 61q45 63 0 178-2 13-4.5 20t4.5 12.5 12 7.5 17 6q57 18 103 47t80 81.5 34 116.5zm-74-624q42 47 54.5 108.5t-6.5 117.5q-8 23-29.5 34t-44.5 4q-23-8-34-29.5t-4-44.5q20-63-24-111t-107-35q-24 5-45-8t-25-37q-5-24 8-44.5t37-25.5q60-13 119 5.5t101 65.5zm181-163q87 96 112.5 222.5t-13.5 241.5q-9 27-34 40t-52 4-40-34-5-52q28-82 10-172t-80-158q-62-69-148-95.5t-173-8.5q-28 6-52-9.5t-30-43.5 9.5-51.5 43.5-29.5q123-26 244 11.5t208 134.5z"/>
        </svg>
      </a>
    </div>
  </div>
</footer>
</section>

</body>
</html>

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    <meta name="description" content="Think less, do more.">
  

  
    <meta name="author" content="parryworld">
  

  
  <title>React Native ListView 强制刷新 | Parryworld</title>

  <link rel="stylesheet" href="/blog/css/style.css">

  <link href='//fonts.googleapis.com/css?family=Bitter:400,700,400italic|Open+Sans:400italic,600italic,400,600' rel='stylesheet' type='text/css'>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>

    <section class="container">
  <header class="post-header">
    <h1>React Native ListView 强制刷新</h1>
  </header>

  <article class="post-body">
    <h2 id="问题由来"><a href="#问题由来" class="headerlink" title="问题由来"></a>问题由来</h2><p>在 React Native 中，ListView 中的数据是这样定义的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> ds = <span class="keyword">new</span> ListView.DataSource(&#123;<span class="attr">rowHasChanged</span>: <span class="function">(<span class="params">r1, r2</span>) =&gt;</span> r1 !== r2&#125;);</div><div class="line"><span class="keyword">this</span>.state = &#123;</div><div class="line">  <span class="attr">dataSource</span>: ds</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>当要更新 ListView 时，通过 <code>cloneWithRows</code> 来设置 ListView 中的内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.setState(&#123;</div><div class="line">  <span class="attr">dataSource</span>: <span class="keyword">this</span>.state.dataSource.cloneWithRows(posts)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">posts = [</div><div class="line">  &#123; <span class="attr">title</span>: <span class="string">'JavaScript'</span>, <span class="attr">content</span>: <span class="string">'xxx'</span> &#125;,</div><div class="line">  &#123; <span class="attr">title</span>: <span class="string">'Android'</span>, <span class="attr">content</span>: <span class="string">'xxx'</span> &#125;,</div><div class="line">  &#123; <span class="attr">title</span>: <span class="string">'iOS'</span>, <span class="attr">content</span>: <span class="string">'xxx'</span> &#125;</div><div class="line">];</div></pre></td></tr></table></figure>
<p>当我们向 posts 数组添加一行，或者删除一行，或者把另一行替换成新的对象，通过 <code>cloneWithRows</code> 调用后，ListView 就会对变化的行重新渲染，通过调用 <code>renderRow</code> 方法。</p>
<h5 id="React-Native-是如何判断-ListView-的变化的呢？"><a href="#React-Native-是如何判断-ListView-的变化的呢？" class="headerlink" title="React Native 是如何判断 ListView 的变化的呢？"></a>React Native 是如何判断 ListView 的变化的呢？</h5><p>就是通过之前定义的 <code>{rowHasChanged: (r1, r2) =&gt; r1 !== r2}</code> 方式，旧的 posts 和新的 posts 数组下的对象引用不同时，就会重新渲染相应的行。</p>
<p>这种方式可以大量减少不必要的行渲染。</p>
<h4 id="那么当行对象引用没有变化时，ListView-就不会调用-renderRow，比如下下面两种情景："><a href="#那么当行对象引用没有变化时，ListView-就不会调用-renderRow，比如下下面两种情景：" class="headerlink" title="那么当行对象引用没有变化时，ListView 就不会调用 renderRow，比如下下面两种情景："></a>那么当行对象引用没有变化时，ListView 就不会调用 <code>renderRow</code>，比如下下面两种情景：</h4><ul>
<li>修改行对象里的属性，但是没有返回新的对象</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">posts[<span class="number">0</span>].title = <span class="string">'React'</span>;</div></pre></td></tr></table></figure>
<p>哪怕你执行了下面的代码，ListView 也不会有任何变化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.setState(&#123;</div><div class="line">  <span class="attr">dataSource</span>: <span class="keyword">this</span>.state.dataSource.cloneWithRows(posts)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>向行组件传递新的属性，比如下面的 showButton 属性</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">renderRow(post) &#123;</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    &lt;PostRow</div><div class="line">      post=&#123;post&#125;</div><div class="line">      showButton=&#123;this.state.showButton&#125;</div><div class="line">    /&gt;</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为 ListView 中的 dataSource 没有变化，就算 showButton 从 false 变为 true，<code>renderRow</code> 方法也不会调用。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><h4 id="针对第一种情景：修改行对象里的属性"><a href="#针对第一种情景：修改行对象里的属性" class="headerlink" title="针对第一种情景：修改行对象里的属性"></a>针对第一种情景：修改行对象里的属性</h4><p>当要修改行对象的内容时，尽量返回新的对象，比如下面这种写法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">posts[<span class="number">0</span>] = &#123;</div><div class="line">  ...posts[<span class="number">0</span>],</div><div class="line">  <span class="attr">title</span>: <span class="string">'React'</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如果你不想返回新的对象，还是想通过 <code>posts[0].title = &#39;React&#39;</code> 来修改内容的话，当你想要重新渲染行的时候，可以创建新的 posts 数组复制生成相应要渲染的行对象，再调用 <code>cloneWithRows</code> 方法，比如下面的代码重新渲染整个列表。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> newPosts = posts.map(<span class="function">(<span class="params">post</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> &#123;...post&#125;;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">this</span>.setState(&#123;</div><div class="line">  <span class="attr">dataSource</span>: <span class="keyword">this</span>.state.dataSource.cloneWithRows(newPosts)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="针对第二种情景：向行组件传递新的属性"><a href="#针对第二种情景：向行组件传递新的属性" class="headerlink" title="针对第二种情景：向行组件传递新的属性"></a>针对第二种情景：向行组件传递新的属性</h4><p>如果想把 <code>this.state.showButton</code> 的值传递给某一行组件的属性，必须要强制调用这一行的 <code>renderRow</code> 方法，同样也是创建新的 posts 数组，要么渲染整个列表，要么渲染相应的行。比如下面的代码会重新渲染首行和最后一行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> newPosts = posts.map(<span class="function">(<span class="params">post, index</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span> (index === <span class="number">0</span> || index === posts.length - <span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;...post&#125;;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> post;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">this</span>.setState(&#123;</div><div class="line">  <span class="attr">dataSource</span>: <span class="keyword">this</span>.state.dataSource.cloneWithRows(newPosts)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="其他解决方法"><a href="#其他解决方法" class="headerlink" title="其他解决方法"></a>其他解决方法</h4><p>关于 ListView 是否需要 <code>renderRow</code> 来重新渲染，是依据 <code>{rowHasChanged: (r1, r2) =&gt; r1 !== r2}</code> 来判断的，根据具体情况来修改 <code>rowHasChanged</code> 里的判断方法，也能起到类似的效果。</p>

  </article>

  <footer class="post-footer">
  <div class="contact clearfix">
    <div class="social">
      <span>Contact me @ </span>
      <div class="icon-wrapper">
        <svg class="social-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22,3H2A2,2,0,0,0,0,5V19a2,2,0,0,0,2,2H22a2,2,0,0,0,2-2V5A2,2,0,0,0,22,3ZM12,9.88,4.07,4H19.93ZM4,9.21l7.7,5.69a.5.5,0,0,0,.59,0L20,9.21V20H4Z" />
        </svg>
        <div class="icon-info">
          <p>parryworld@gmail.com</p>
        </div>
      </div>
      <a href="https://github.com/parryworld" target="_blank">
        <svg class="social-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
          <path d="M512 0C229.25 0 0 229.25 0 512c0 226.25 146.688 418.125 350.156 485.812 25.594 4.688 34.938-11.125 34.938-24.625 0-12.188-0.469-52.562-0.719-95.312C242 908.812 211.906 817.5 211.906 817.5c-23.312-59.125-56.844-74.875-56.844-74.875-46.531-31.75 3.53-31.125 3.53-31.125 51.406 3.562 78.47 52.75 78.47 52.75 45.688 78.25 119.875 55.625 149 42.5 4.654-33 17.904-55.625 32.5-68.375C304.906 725.438 185.344 681.5 185.344 485.312c0-55.938 19.969-101.562 52.656-137.406-5.219-13-22.844-65.094 5.062-135.562 0 0 42.938-13.75 140.812 52.5 40.812-11.406 84.594-17.031 128.125-17.219 43.5 0.188 87.312 5.875 128.188 17.281 97.688-66.312 140.688-52.5 140.688-52.5 28 70.531 10.375 122.562 5.125 135.5 32.812 35.844 52.625 81.469 52.625 137.406 0 196.688-119.75 240-233.812 252.688 18.438 15.875 34.75 47 34.75 94.75 0 68.438-0.688 123.625-0.688 140.5 0 13.625 9.312 29.562 35.25 24.562C877.438 930 1024 738.125 1024 512 1024 229.25 794.75 0 512 0z"/>
        </svg>
      </a>
      <a href="http://weibo.com/parryworld" target="_blank">
        <svg class="social-icon" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
          <path d="M675 1284q21-34 11-69t-45-50q-34-14-73-1t-60 46q-22 34-13 68.5t43 50.5 74.5 2.5 62.5-47.5zm94-121q8-13 3.5-26.5t-17.5-18.5q-14-5-28.5.5t-21.5 18.5q-17 31 13 45 14 5 29-.5t22-18.5zm174 107q-45 102-158 150t-224 12q-107-34-147.5-126.5t6.5-187.5q47-93 151.5-139t210.5-19q111 29 158.5 119.5t2.5 190.5zm312-160q-9-96-89-170t-208.5-109-274.5-21q-223 23-369.5 141.5t-132.5 264.5q9 96 89 170t208.5 109 274.5 21q223-23 369.5-141.5t132.5-264.5zm308 4q0 68-37 139.5t-109 137-168.5 117.5-226 83-270.5 31-275-33.5-240.5-93-171.5-151-65-199.5q0-115 69.5-245t197.5-258q169-169 341.5-236t246.5 7q65 64 20 209-4 14-1 20t10 7 14.5-.5 13.5-3.5l6-2q139-59 246-59t153 61q45 63 0 178-2 13-4.5 20t4.5 12.5 12 7.5 17 6q57 18 103 47t80 81.5 34 116.5zm-74-624q42 47 54.5 108.5t-6.5 117.5q-8 23-29.5 34t-44.5 4q-23-8-34-29.5t-4-44.5q20-63-24-111t-107-35q-24 5-45-8t-25-37q-5-24 8-44.5t37-25.5q60-13 119 5.5t101 65.5zm181-163q87 96 112.5 222.5t-13.5 241.5q-9 27-34 40t-52 4-40-34-5-52q28-82 10-172t-80-158q-62-69-148-95.5t-173-8.5q-28 6-52-9.5t-30-43.5 9.5-51.5 43.5-29.5q123-26 244 11.5t208 134.5z"/>
        </svg>
      </a>
    </div>
  </div>
</footer>
</section>

</body>
</html>
